// Copy this ENTIRE code into Google Apps Script
// Make sure to copy everything from function doGet to the closing brace

// ===== FIREBASE CONFIGURATION =====
const FIREBASE_PROJECT_ID = 'test-6f184';
const FIREBASE_SERVICE_ACCOUNT_EMAIL = 'firebase-adminsdk-fbsvc@test-6f184.iam.gserviceaccount.com';
const FIREBASE_PRIVATE_KEY = '-----BEGIN PRIVATE KEY-----\nMIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQDCONiVv5dRszyU\n4cCSzyYs78e91RAKGr7vrUz+9O1jfYR/HZv5iQb2iIGgZHDVb0gz0H0FLVGpcgZJ\n6qGxoeda254lqk5V+obnseTeushSWBvBsh/qWGRiBLzVc1oof/liXiFEEXa6Rh8/\nFuOHgS+xMhl4itdNGSp920XR2XH0gTvQd2LOpp/IIMiHMbhYx9ixE+INRpJ0+3EA\nkXQWSboCMReiPjk+tRv/9Ly8dNB5Dhsw3/BtzK52JrpGs8Qo+Zn6XuZ0vnIyIBoq\nLrFdITJHPysfFa1eR+Lb+Tyk6oupCTTeYKFAlltNt0+k7d5LqSj7cCDxuUCjV8QD\nucUxw6/7AgMBAAECggEAGRH0ZxQFiM69jaw8StcBYwCKhGb5vIwqRE7W5vwfnl2H\n2k6soP++jdkd/mGorOxB4ipR0PbCGUC2LhliyMaQ0goSNmNu3CtL+aFdXSC4FeT4\npD6FXx8Myhg5dcX/h8XJH5jt61bjv/SoOOEP+qBC0zkXz5cAZpvOf9NrhkRusLQ6\nCXaQMEeACW1r77cw5WlgaO3BC8OvRNgxfUNUamSdc553/0V8KdgabgAtmN0EJpsi\nU3SwRh5Qkf9kOEpcgMRrXcbAxjgYEHU4so38/B0mkGqNTYoFZzE+jo0Otwg4ddWa\nzyinK0V0WPkhJFzzxCmOes3H1DGFH19J62j708cx3QKBgQDy0SZG6aVfmQaloKXM\nPQ0hFwNC+gZlh9uPlhcqILbYhC3sQABPgwIb9O+noG7bIUkR63wz0fkIT+HrrmOO\nOvquV6SjUUwowQ6qRbKBVVwq4xvKlQc/aodeekmbxemG+kQ9/4sennzQNMI4FbCa\nX5Uh+UbVfHtp1ZOwLe5qSAwbrQKBgQDMxEnAMNm4HSSYje+htNxzDK06JsM5LnIj\nIX3auaOmjNu0W0/7Nu62r2n80rXmdyhfbHzJXrH2PjzAMzDheumREjlFB9oEEJmQ\ntAAByYRWvFUyU6LCd42QU3mDHvq9O5sjXMzQsiZiynlZD75MQX9kXtSOvvbGVFfO\nky0EnQhvRwKBgQCsNrxQFQwuNikptTuCFFbIfjrY+N0qi2Wke83oGhW0kGLFqUrP\nGdqYG2sR105oaj4Z0IthcW2PgKB5+FAxoxECL7TcBB/g07Pj/dSxt+nLnRGr53Ch\ngJuL3W1xZrfO/JcD5cc0qzFYteJ9xpxfkKUD2HltloEtOcYqcRkkFf9IbQKBgQCT\nvHtJgvVSdRRWTPG7xfXXvCmvbxAjTXNkDWH0UUPVgoNxmQAXzAZnICBkHNLIuOgU\nEP3ne78CXt0N/uEhjcC+vls7hvKxRBjH4lau82nb+n2tldI0ZHVq0A83nz5hEYRY\n+zd6y04OsO7kZwtxkUAMdq79XqJFbcz8agts7K+NOQKBgCg/d8vVX9u5mY0cPoQK\n4lWiOd8lGIMAAYDu8ROiXUqeRBIWgM+2xX62d6WCMrMgOmhaFCCsyD6WvkCZS/tT\nJfMUjuX//SwsVaomqiauFlgW/FMySQf+Wor6Ta4uLzgDJawCcYBSNV7+ZXaaIr+U\nj+cLGYUb/XHiPHAsyKYFk9PM\n-----END PRIVATE KEY-----\n';

// Firestore API endpoint
const FIRESTORE_URL = `https://firestore.googleapis.com/v1/projects/${FIREBASE_PROJECT_ID}/databases/(default)/documents`;

// ===== FIREBASE HELPER FUNCTIONS =====

// Get OAuth2 access token for Firebase
function getFirebaseAccessToken() {
  const service = OAuth2.createService('Firebase')
    .setTokenUrl('https://oauth2.googleapis.com/token')
    .setPrivateKey(FIREBASE_PRIVATE_KEY)
    .setIssuer(FIREBASE_SERVICE_ACCOUNT_EMAIL)
    .setSubject(FIREBASE_SERVICE_ACCOUNT_EMAIL)
    .setPropertyStore(PropertiesService.getScriptProperties())
    .setScope('https://www.googleapis.com/auth/datastore');
  
  return service.getAccessToken();
}

// Convert data to Firestore format
function convertToFirestoreFields(data) {
  const fields = {};
  for (let key in data) {
    const value = data[key];
    
    if (value === null || value === undefined) {
      fields[key] = { nullValue: null };
    } else if (typeof value === 'string') {
      fields[key] = { stringValue: value };
    } else if (typeof value === 'number') {
      if (Number.isInteger(value)) {
        fields[key] = { integerValue: String(value) };
      } else {
        fields[key] = { doubleValue: value };
      }
    } else if (typeof value === 'boolean') {
      fields[key] = { booleanValue: value };
    } else if (Array.isArray(value)) {
      fields[key] = { 
        arrayValue: { 
          values: value.map(v => {
            if (typeof v === 'string') return { stringValue: v };
            if (typeof v === 'number') return { doubleValue: v };
            if (typeof v === 'boolean') return { booleanValue: v };
            return { stringValue: String(v) };
          })
        } 
      };
    } else if (typeof value === 'object') {
      fields[key] = { mapValue: { fields: convertToFirestoreFields(value) } };
    } else {
      fields[key] = { stringValue: String(value) };
    }
  }
  return fields;
}

// Save data to Firestore
function saveToFirestore(collectionName, data) {
  try {
    const accessToken = getFirebaseAccessToken();
    const url = `${FIRESTORE_URL}/${collectionName}`;
    
    const payload = {
      fields: convertToFirestoreFields(data)
    };
    
    const options = {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + accessToken,
        'Content-Type': 'application/json'
      },
      payload: JSON.stringify(payload),
      muteHttpExceptions: true
    };
    
    const response = UrlFetchApp.fetch(url, options);
    const responseCode = response.getResponseCode();
    const responseText = response.getContentText();
    
    Logger.log('Firestore Save Response Code: ' + responseCode);
    Logger.log('Firestore Save Response: ' + responseText);
    
    if (responseCode === 200 || responseCode === 201) {
      Logger.log('✓ Successfully saved to Firestore');
      return JSON.parse(responseText);
    } else {
      Logger.log('✗ Error saving to Firestore: ' + responseText);
      throw new Error('Firestore save failed: ' + responseText);
    }
  } catch (error) {
    Logger.log('✗✗✗ Exception saving to Firestore: ' + error.toString());
    throw error;
  }
}

// Helper function to format answer values to readable text
function formatAnswer(questionKey, answerValue) {
  const answerMaps = {
    incomeStability: {
      'government_psu': 'Government / PSU',
      'large_mnc': 'Large MNC (Salaried)',
      'stable_sme': 'Stable SME Job',
      'startup_unstable': 'Startup/Private (Unstable)',
      'variable_freelance': 'Variable/Freelance Income'
    },
    savingsRate: {
      'less_10': 'Less than 10%',
      '10_20': '10% - 20%',
      '20_35': '20% - 35%',
      'more_35': 'More than 35%'
    },
    emergencyFund: {
      'less_3': 'Less than 3 months',
      '3_6': '3 - 6 months',
      '6_12': '6 - 12 months',
      'more_12': 'More than 12 months'
    },
    dependents: {
      '0': '0 (None)',
      '1': '1',
      '2': '2',
      '3_plus': '3 or more'
    },
    emiIncomeRatio: {
      'less_10': 'Less than 10%',
      '10_25': '10% - 25%',
      '25_40': '25% - 40%',
      'more_40': 'More than 40%'
    },
    jobReplaceability: {
      'less_2_months': 'Less than 2 months',
      '3_4_months': '3 - 4 months',
      '6_plus_months': '6 months or more'
    },
    investmentDuration: {
      'less_3': 'Less than 3 years',
      '3_5': '3 - 5 years',
      '5_10': '5 - 10 years',
      'more_10': 'More than 10 years'
    },
    goalFlexibility: {
      'fixed': 'Fixed deadline (cannot be changed)',
      'semi_flexible': 'Semi-flexible (can be adjusted slightly)',
      'fully_flexible': 'Fully flexible (no strict deadline)'
    },
    budgetTracking: {
      'none': 'I don\'t track my budget',
      'occasional': 'Occasionally (when I remember)',
      'strict': 'Strict tracking (regularly maintained)'
    },
    investmentConsistency: {
      'irregular': 'Irregular (miss many months)',
      'sometimes': 'Sometimes consistent',
      'consistent': 'Consistent (rarely miss)'
    },
    marketReaction: {
      'sold': 'Sold some or all investments',
      'held': 'Held investments (did nothing)',
      'added': 'Added more investments (bought the dip)'
    },
    portfolioMonitoring: {
      'daily': 'Daily (emotional checking)',
      'weekly': 'Weekly',
      'monthly': 'Monthly',
      'rarely': 'Rarely (only when needed)'
    },
    annualIncome: {
      'less_5_lakhs': 'Less than ₹5 lakhs',
      '5_10_lakhs': '₹5 lakhs - ₹10 lakhs',
      '10_25_lakhs': '₹10 lakhs - ₹25 lakhs',
      '25_50_lakhs': '₹25 lakhs - ₹50 lakhs',
      '50_lakhs_1_crore': '₹50 lakhs - ₹1 crore',
      'above_1_crore': 'Above ₹1 crore'
    },
    knowledgeLevel: {
      'beginner': 'Beginner (Limited knowledge)',
      'intermediate': 'Intermediate (Some knowledge)',
      'advanced': 'Advanced (Good knowledge)',
      'expert': 'Expert (Extensive knowledge)'
    },
    monthlyExpenses: {
      'less_20k': 'Less than ₹20,000',
      '20k_50k': '₹20,000 - ₹50,000',
      '50k_1lakh': '₹50,000 - ₹1 lakh',
      '1lakh_2lakh': '₹1 lakh - ₹2 lakhs',
      'above_2lakh': 'Above ₹2 lakhs'
    },
    numDependents: {
      '0': '0 (None)',
      '1': '1',
      '2': '2',
      '3': '3',
      '4_plus': '4 or more'
    },
    dependentsAgeGroup: {
      'no_dependents': 'No dependents',
      'all_adults': 'All adults (self-sufficient)',
      'mix_adults_children': 'Mix of adults and children',
      'all_children': 'All children (under 18)',
      'elderly': 'Elderly dependents'
    },
    netWorth: {
      'less_10lakhs': 'Less than ₹10 lakhs',
      '10lakhs_25lakhs': '₹10 lakhs - ₹25 lakhs',
      '25lakhs_50lakhs': '₹25 lakhs - ₹50 lakhs',
      '50lakhs_1crore': '₹50 lakhs - ₹1 crore',
      '1crore_5crore': '₹1 crore - ₹5 crores',
      'above_5crore': 'Above ₹5 crores'
    },
    liquidAssetsRatio: {
      'less_10': 'Less than 10%',
      '10_20': '10% - 20%',
      '20_30': '20% - 30%',
      '30_50': '30% - 50%',
      'above_50': 'Above 50%'
    },
    investmentRatio: {
      'less_20': 'Less than 20%',
      '20_40': '20% - 40%',
      '40_60': '40% - 60%',
      '60_80': '60% - 80%',
      'above_80': 'Above 80%'
    },
    realEstateRatio: {
      '0': '0% (No real estate)',
      'less_30': 'Less than 30%',
      '30_50': '30% - 50%',
      '50_70': '50% - 70%',
      'above_70': 'Above 70%'
    },
    debtToNetWorth: {
      '0': '0% (No debt)',
      'less_20': 'Less than 20%',
      '20_40': '20% - 40%',
      '40_60': '40% - 60%',
      'above_60': 'Above 60%'
    },
    financialStability: {
      'very_stable': 'Very stable (high savings, low debt, secure income)',
      'stable': 'Stable (adequate savings, manageable debt)',
      'moderate': 'Moderate (some savings, moderate debt)',
      'unstable': 'Unstable (low savings, high debt)',
      'very_unstable': 'Very unstable (no savings, high debt burden)'
    },
    investmentExperienceYears: {
      '0': '0 years (No experience)',
      '1_2': '1 - 2 years',
      '3_5': '3 - 5 years',
      '6_10': '6 - 10 years',
      'above_10': 'Above 10 years'
    },
    investmentTypes: {
      'only_safe': 'Only safe investments (FDs, Savings, PPF)',
      'mostly_safe': 'Mostly safe with some debt funds',
      'balanced': 'Balanced mix (Equity, Debt, Gold)',
      'mostly_equity': 'Mostly equity (Mutual funds, stocks)',
      'diversified': 'Highly diversified (Equity, Debt, Real Estate, Gold, Alternatives)'
    }
  };
  
  if (answerMaps[questionKey] && answerMaps[questionKey][answerValue]) {
    return answerMaps[questionKey][answerValue];
  }
  return answerValue || 'Not answered';
}

// Function to format email with questionnaire and answers
function formatQuestionnaireEmail(name, answers, riskBucket, riskScore, equityAlloc, debtAlloc, altAlloc) {
  const questions = [
    // Financial Information
    { key: 'annualIncome', text: '1. What is your annual income?', isNumber: false },
    { key: 'monthlyExpenses', text: '2. What are your monthly expenses?', isNumber: false },
    { key: 'numDependents', text: '3. How many dependents do you have?', isNumber: false },
    { key: 'dependentsAgeGroup', text: '4. What is the age group of your dependents?', isNumber: false },
    { key: 'netWorth', text: '5. What is your approximate net worth?', isNumber: false },
    { key: 'liquidAssetsRatio', text: '6. What percentage of your net worth is in liquid assets?', isNumber: false },
    { key: 'investmentRatio', text: '7. What percentage of your net worth is in investments?', isNumber: false },
    { key: 'realEstateRatio', text: '8. What percentage of your net worth is in real estate?', isNumber: false },
    { key: 'debtToNetWorth', text: '9. What is your debt to net worth ratio?', isNumber: false },
    { key: 'financialStability', text: '10. How would you describe your current financial stability?', isNumber: false },
    
    // Investment Experience
    { key: 'investmentExperienceYears', text: '11. How many years of investment experience do you have?', isNumber: false },
    { key: 'investmentTypes', text: '12. What types of investments have you primarily held?', isNumber: false },
    { key: 'knowledgeLevel', text: '13. What is your knowledge level about investments?', isNumber: false },
    
    // Risk Capacity Questions
    { key: 'incomeStability', text: '14. What is your employment type?', isNumber: false },
    { key: 'savingsRate', text: '15. What percentage of your monthly income do you invest/save?', isNumber: false },
    { key: 'emergencyFund', text: '16. How many months of expenses do you have in your emergency fund?', isNumber: false },
    { key: 'dependents', text: '17. How many dependents do you have?', isNumber: false },
    { key: 'emiIncomeRatio', text: '18. What is your EMI (loan payments) to Income ratio?', isNumber: false },
    { key: 'jobReplaceability', text: '19. How long would it take you to find a similar job if you lost your current one?', isNumber: false },
    { key: 'investmentDuration', text: '20. What is your investment duration/horizon?', isNumber: false },
    { key: 'goalFlexibility', text: '21. How flexible is your investment goal deadline?', isNumber: false },
    
    // Risk Behaviour Questions
    { key: 'budgetTracking', text: '22. How do you track your budget and expenses?', isNumber: false },
    { key: 'investmentConsistency', text: '23. How consistent is your investment habit (SIP/regular investments)?', isNumber: false },
    { key: 'marketReaction', text: '24. What did you do during the last major market fall/crash?', isNumber: false },
    { key: 'portfolioMonitoring', text: '25. How often do you check your investment portfolio?', isNumber: false }
  ];
  
  let html = `
    <html>
      <body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333;">
        <div style="max-width: 600px; margin: 0 auto; padding: 20px;">
          <h2 style="color: #000;">Risk Assessment Questionnaire - Your Responses</h2>
          <p>Dear ${name || 'Valued Client'},</p>
          <p>Thank you for completing the Risk Assessment Questionnaire. Below is a copy of your responses:</p>
          
          <h3 style="color: #000; margin-top: 30px;">Financial Information</h3>
  `;
  
  // Add Financial Information questions (1-10)
  for (let i = 0; i < 10; i++) {
    const q = questions[i];
    let answer = '';
    if (q.isNumber) {
      answer = answers[q.key] ? '₹' + Number(answers[q.key]).toLocaleString('en-IN') : 'Not answered';
    } else if (q.isText) {
      answer = answers[q.key] || 'Not answered';
    } else {
      answer = formatAnswer(q.key, answers[q.key]);
    }
    html += `
      <div style="margin-bottom: 20px; padding: 15px; background-color: #f9f9f9; border-left: 3px solid #000;">
        <p style="margin: 0 0 8px 0; font-weight: bold;">${q.text}</p>
        <p style="margin: 0; color: #555;">Answer: ${answer}</p>
      </div>
    `;
  }
  
  html += `
          <h3 style="color: #000; margin-top: 30px;">Investment Experience</h3>
  `;
  
  // Add Investment Experience questions (11-13)
  for (let i = 10; i < 13; i++) {
    const q = questions[i];
    if (q.optional && !answers[q.key]) {
      continue; // Skip optional questions that weren't answered
    }
    let answer = '';
    if (q.isNumber) {
      answer = answers[q.key] ? answers[q.key] + ' years' : 'Not answered';
    } else if (q.isText) {
      answer = answers[q.key] || 'Not answered';
    } else {
      answer = formatAnswer(q.key, answers[q.key]);
    }
    html += `
      <div style="margin-bottom: 20px; padding: 15px; background-color: #f9f9f9; border-left: 3px solid #000;">
        <p style="margin: 0 0 8px 0; font-weight: bold;">${q.text}</p>
        <p style="margin: 0; color: #555;">Answer: ${answer}</p>
      </div>
    `;
  }
  
  html += `
          <h3 style="color: #000; margin-top: 30px;">Risk Capacity Assessment</h3>
  `;
  
  // Add Risk Capacity questions (14-21)
  for (let i = 13; i < 21; i++) {
    const q = questions[i];
    const answer = formatAnswer(q.key, answers[q.key]);
    html += `
      <div style="margin-bottom: 20px; padding: 15px; background-color: #f9f9f9; border-left: 3px solid #000;">
        <p style="margin: 0 0 8px 0; font-weight: bold;">${q.text}</p>
        <p style="margin: 0; color: #555;">Answer: ${answer}</p>
      </div>
    `;
  }
  
  html += `
          <h3 style="color: #000; margin-top: 30px;">Risk Behaviour Assessment</h3>
  `;
  
  // Add Risk Behaviour questions (22-25)
  for (let i = 21; i < 25; i++) {
    const q = questions[i];
    const answer = formatAnswer(q.key, answers[q.key]);
    html += `
      <div style="margin-bottom: 20px; padding: 15px; background-color: #f9f9f9; border-left: 3px solid #000;">
        <p style="margin: 0 0 8px 0; font-weight: bold;">${q.text}</p>
        <p style="margin: 0; color: #555;">Answer: ${answer}</p>
      </div>
    `;
  }
  
  html += `
          <h3 style="color: #000; margin-top: 30px;">Your Risk Assessment Results</h3>
          <div style="background-color: #f0f0f0; padding: 20px; border-radius: 5px; margin-top: 15px;">
            <p style="margin: 5px 0;"><strong>Risk Score:</strong> ${riskScore || 'N/A'}</p>
            <p style="margin: 5px 0;"><strong>Risk Profile:</strong> ${riskBucket || 'N/A'}</p>
            <p style="margin: 5px 0;"><strong>Indicative Asset Allocation:</strong></p>
            <ul style="margin: 10px 0; padding-left: 20px;">
              <li>Equity: ${equityAlloc || 'N/A'}</li>
              <li>Debt: ${debtAlloc || 'N/A'}</li>
              <li>Alternatives: ${altAlloc || 'N/A'}</li>
            </ul>
          </div>
          
          <p style="margin-top: 30px; font-size: 0.9em; color: #666;">
            <em>Note: This is indicative risk profile and educational allocation guidance. Investment advice is provided only after formal client onboarding and suitability assessment.</em>
          </p>
          
          <p style="margin-top: 20px;">Best regards,<br>Financial Planning Advisory – Gautam Kathuria</p>
        </div>
      </body>
    </html>
  `;
  
  return html;
}

// This function is for testing - when you open the URL in browser
function doGet(e) {
  return ContentService.createTextOutput(JSON.stringify({
    status: 'OK',
    message: 'Google Apps Script is working! Use POST to send data.'
  }))
    .setMimeType(ContentService.MimeType.JSON);
}

// Test function to verify email sending works
// Run this function manually in Google Apps Script to test email
function testEmailSending() {
  try {
    const testEmail = 'Gautamkathuria0909@gmail.com'; // Replace with your email for testing
    const testAnswers = {
      incomeStability: 'large_mnc',
      savingsRate: '20_35',
      emergencyFund: '6_12',
      dependents: '0',
      emiIncomeRatio: 'less_10',
      jobReplaceability: 'less_2_months',
      investmentDuration: 'more_10',
      goalFlexibility: 'fully_flexible',
      budgetTracking: 'strict',
      investmentConsistency: 'consistent',
      marketReaction: 'held',
      portfolioMonitoring: 'monthly'
    };
    
    Logger.log('Testing email sending to: ' + testEmail);
    
    const emailBody = formatQuestionnaireEmail(
      'Test User',
      testAnswers,
      'Moderate',
      '65.5',
      '60-70%',
      '20-30%',
      '5-10%'
    );
    
    MailApp.sendEmail({
      to: testEmail,
      subject: 'TEST - Your Risk Assessment Questionnaire - Financial Planning Advisory',
      htmlBody: emailBody,
      name: 'Financial Planning Advisory - Gautam Kathuria'
    });
    
    Logger.log('✓ Test email sent successfully!');
    return 'Test email sent to ' + testEmail;
  } catch (error) {
    Logger.log('✗ Test email failed: ' + error.toString());
    return 'Test email failed: ' + error.toString();
  }
}

// Test function that simulates a POST request with data
// This helps test the doPost function with actual data
function testDoPostWithData() {
  try {
    Logger.log('=== Testing doPost with simulated data ===');
    
    // Create a mock POST event object
    const mockData = {
      name: 'Test User',
      age: '25',
      email: 'Gautamkathuria0909@gmail.com',
      phone: '1234567890',
      service: 'Holistic Financial Planning',
      riskCapacity: 65.5,
      riskBehaviour: 70.2,
      riskScore: 67.85,
      riskBucket: 'Moderate',
      equityAllocation: '60-70%',
      debtAllocation: '20-30%',
      alternativesAllocation: '5-10%',
      sendCopy: true, // THIS IS THE KEY - set to true
      answers: {
        incomeStability: 'large_mnc',
        savingsRate: '20_35',
        emergencyFund: '6_12',
        dependents: '0',
        emiIncomeRatio: 'less_10',
        jobReplaceability: 'less_2_months',
        investmentDuration: 'more_10',
        goalFlexibility: 'fully_flexible',
        budgetTracking: 'strict',
        investmentConsistency: 'consistent',
        marketReaction: 'held',
        portfolioMonitoring: 'monthly'
      },
      type: 'assessment',
      timestamp: new Date().toISOString()
    };
    
    const mockEvent = {
      postData: {
        contents: JSON.stringify(mockData)
      }
    };
    
    Logger.log('Calling doPost with mock data...');
    Logger.log('sendCopy in mock data: ' + mockData.sendCopy);
    
    // Call doPost with the mock event
    const result = doPost(mockEvent);
    
    Logger.log('doPost result: ' + result.getContent());
    return 'Test completed. Check logs above.';
  } catch (error) {
    Logger.log('✗ Test failed: ' + error.toString());
    return 'Test failed: ' + error.toString();
  }
}

// This function handles data from your website
function doPost(e) {
  try {
    Logger.log('========================================');
    Logger.log('=== doPost CALLED ===');
    Logger.log('Timestamp: ' + new Date().toISOString());
    Logger.log('Has event object (e): ' + (e ? 'YES' : 'NO'));
    Logger.log('Has postData: ' + (e && e.postData ? 'YES' : 'NO'));
    
    if (e && e.postData) {
      Logger.log('postData.contents exists: ' + (e.postData.contents ? 'YES' : 'NO'));
      if (e.postData.contents) {
        Logger.log('postData.contents length: ' + e.postData.contents.length + ' characters');
        Logger.log('postData.contents preview (first 200 chars): ' + e.postData.contents.substring(0, 200));
      }
    }
    
    // Check if we have post data
    if (!e || !e.postData || !e.postData.contents) {
      Logger.log('✗✗✗ ERROR: No post data received');
      Logger.log('Event object structure: ' + JSON.stringify(Object.keys(e || {})));
      return ContentService.createTextOutput(JSON.stringify({error: 'No data received'}))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    Logger.log('✓ Post data received, parsing JSON...');
    let data;
    try {
      data = JSON.parse(e.postData.contents);
      Logger.log('✓ JSON parsed successfully');
    } catch (parseError) {
      Logger.log('✗✗✗ ERROR parsing JSON: ' + parseError.toString());
      Logger.log('Raw contents: ' + e.postData.contents);
      return ContentService.createTextOutput(JSON.stringify({
        error: 'JSON parse error',
        message: parseError.toString()
      })).setMimeType(ContentService.MimeType.JSON);
    }
    
    Logger.log('Data type: ' + (data.type || 'MISSING'));
    Logger.log('Data keys: ' + Object.keys(data).join(', '));
    Logger.log('Full data object: ' + JSON.stringify(data));
    
    // Handle discovery form submission
    if (data.type === 'discovery') {
      Logger.log('Processing discovery form submission');
      
      const firestoreData = {
        name: data.name || '',
        age: data.age || '',
        email: data.email || '',
        phone: data.phone || '',
        service: data.service || '',
        timestamp: new Date().toISOString(),
        status: 'discovery_only' // Mark as discovery form only
      };
      
      try {
        saveToFirestore('clients', firestoreData);
        Logger.log('✓ Discovery form data saved to Firestore');
      } catch (firestoreError) {
        Logger.log('✗✗✗ ERROR saving discovery form to Firestore: ' + firestoreError.toString());
        // Continue execution even if Firestore save fails
      }
    }
    
    // Handle risk assessment submission
    if (data.type === 'assessment') {
      Logger.log('========================================');
      Logger.log('Processing assessment submission');
      Logger.log('Assessment data received at: ' + new Date().toISOString());
      
      const answers = data.answers || {};
      
      // Prepare Firestore data
      const firestoreData = {
        name: data.name || '',
        age: data.age || '',
        email: data.email || '',
        phone: data.phone || '',
        service: data.service || '',
        // Financial Information
        annualIncome: answers.annualIncome || '',
        monthlyExpenses: answers.monthlyExpenses || '',
        numDependents: answers.numDependents || '',
        dependentsAgeGroup: answers.dependentsAgeGroup || '',
        netWorth: answers.netWorth || '',
        liquidAssetsRatio: answers.liquidAssetsRatio || '',
        investmentRatio: answers.investmentRatio || '',
        realEstateRatio: answers.realEstateRatio || '',
        debtToNetWorth: answers.debtToNetWorth || '',
        financialStability: answers.financialStability || '',
        // Investment Experience
        investmentExperienceYears: answers.investmentExperienceYears || '',
        investmentTypes: answers.investmentTypes || '',
        knowledgeLevel: answers.knowledgeLevel || '',
        // Risk Capacity Questions
        incomeStability: answers.incomeStability || '',
        savingsRate: answers.savingsRate || '',
        emergencyFund: answers.emergencyFund || '',
        dependents: answers.dependents || '',
        emiIncomeRatio: answers.emiIncomeRatio || '',
        jobReplaceability: answers.jobReplaceability || '',
        investmentDuration: answers.investmentDuration || '',
        goalFlexibility: answers.goalFlexibility || '',
        // Risk Behaviour Questions
        budgetTracking: answers.budgetTracking || '',
        investmentConsistency: answers.investmentConsistency || '',
        marketReaction: answers.marketReaction || '',
        portfolioMonitoring: answers.portfolioMonitoring || '',
        // Scores
        financialInfoScore: data.financialInfoScore || 0,
        investmentExperienceScore: data.investmentExperienceScore || 0,
        riskCapacity: data.riskCapacity || 0,
        riskBehaviour: data.riskBehaviour || 0,
        riskScore: data.riskScore || 0,
        riskBucket: data.riskBucket || '',
        equityAllocation: data.equityAllocation || '',
        debtAllocation: data.debtAllocation || '',
        alternativesAllocation: data.alternativesAllocation || '',
        // Full answers object for reference
        answers: answers,
        timestamp: new Date().toISOString()
      };
      
      // Save to Firestore
      try {
        Logger.log('Saving assessment data to Firestore...');
        saveToFirestore('assessments', firestoreData);
        Logger.log('✓ Assessment data saved to Firestore');
      } catch (firestoreError) {
        Logger.log('✗✗✗ ERROR saving assessment to Firestore: ' + firestoreError.toString());
        // Continue execution even if Firestore save fails
      }
      
      // Send email copy if requested
      Logger.log('=== EMAIL CHECK START ===');
      Logger.log('Raw data.sendCopy value: ' + data.sendCopy + ' (type: ' + typeof data.sendCopy + ')');
      Logger.log('Raw data.email value: ' + data.email);
      Logger.log('Raw data.answers present: ' + (data.answers ? 'YES' : 'NO'));
      if (data.answers) {
        Logger.log('answers keys: ' + Object.keys(data.answers).join(', '));
        Logger.log('answers count: ' + Object.keys(data.answers).length);
      }
      
      // Check conditions more explicitly - handle all possible true values
      const sendCopyValue = data.sendCopy;
      const shouldSendEmail = sendCopyValue === true || 
                             sendCopyValue === 'true' || 
                             sendCopyValue === 1 || 
                             sendCopyValue === '1' ||
                             String(sendCopyValue).toLowerCase() === 'true';
      const hasEmail = data.email && String(data.email).trim() !== '';
      const hasAnswers = data.answers && typeof data.answers === 'object' && Object.keys(data.answers).length > 0;
      
      Logger.log('Email conditions check:');
      Logger.log('  shouldSendEmail: ' + shouldSendEmail + ' (sendCopy raw: ' + sendCopyValue + ', type: ' + typeof sendCopyValue + ')');
      Logger.log('  hasEmail: ' + hasEmail + ' (email: ' + data.email + ')');
      Logger.log('  hasAnswers: ' + hasAnswers + ' (answers is object: ' + (typeof data.answers === 'object') + ')');
      
      // TEMPORARY DEBUG: Send email if we have email and answers (regardless of checkbox)
      // This helps verify the email sending works. Remove this after testing.
      if (hasEmail && hasAnswers) {
        Logger.log('DEBUG MODE: Sending email regardless of checkbox (sendCopy was: ' + sendCopyValue + ')');
        try {
          Logger.log('✓ DEBUG: Attempting to send email to: ' + data.email);
          
          const emailBody = formatQuestionnaireEmail(
            data.name, 
            data.answers, 
            data.riskBucket, 
            data.riskScore, 
            data.equityAllocation, 
            data.debtAllocation, 
            data.alternativesAllocation
          );
          
          MailApp.sendEmail({
            to: data.email,
            subject: 'Your Risk Assessment Questionnaire - Financial Planning Advisory',
            htmlBody: emailBody,
            name: 'Financial Planning Advisory - Gautam Kathuria'
          });
          
          Logger.log('✓✓✓ DEBUG: Email sent successfully to: ' + data.email);
        } catch (emailError) {
          Logger.log('✗✗✗ DEBUG: ERROR sending email: ' + emailError.toString());
        }
      }
      
      // Normal check (with checkbox requirement)
      if (shouldSendEmail && hasEmail && hasAnswers) {
        try {
          Logger.log('✓ All conditions met! Attempting to send email to: ' + data.email);
          
          // Generate email body
          const emailBody = formatQuestionnaireEmail(
            data.name, 
            data.answers, 
            data.riskBucket, 
            data.riskScore, 
            data.equityAllocation, 
            data.debtAllocation, 
            data.alternativesAllocation
          );
          
          Logger.log('Email body generated, length: ' + emailBody.length + ' characters');
          
          // Send email using MailApp (uses SMTP internally)
          MailApp.sendEmail({
            to: data.email,
            subject: 'Your Risk Assessment Questionnaire - Financial Planning Advisory',
            htmlBody: emailBody,
            name: 'Financial Planning Advisory - Gautam Kathuria'
          });
          
          Logger.log('✓✓✓ Email sent successfully to: ' + data.email);
        } catch (emailError) {
          Logger.log('✗✗✗ ERROR sending email: ' + emailError.toString());
          Logger.log('Error message: ' + emailError.message);
          Logger.log('Error stack: ' + (emailError.stack || 'No stack trace'));
          
          // Try alternative method using GmailApp as fallback
          try {
            Logger.log('Attempting fallback with GmailApp...');
            const emailBody = formatQuestionnaireEmail(
              data.name, 
              data.answers, 
              data.riskBucket, 
              data.riskScore, 
              data.equityAllocation, 
              data.debtAllocation, 
              data.alternativesAllocation
            );
            
            GmailApp.sendEmail(
              data.email,
              'Your Risk Assessment Questionnaire - Financial Planning Advisory',
              '',
              {
                htmlBody: emailBody,
                name: 'Financial Planning Advisory - Gautam Kathuria'
              }
            );
            Logger.log('✓✓✓ Email sent successfully using GmailApp fallback to: ' + data.email);
          } catch (gmailError) {
            Logger.log('✗✗✗ GmailApp fallback also failed: ' + gmailError.toString());
            Logger.log('GmailApp error message: ' + gmailError.message);
          }
        }
      } else {
        Logger.log('✗ Email NOT sent. Missing conditions:');
        if (!shouldSendEmail) Logger.log('  - sendCopy is false or missing (value: ' + data.sendCopy + ', type: ' + typeof data.sendCopy + ')');
        if (!hasEmail) Logger.log('  - email is missing or empty');
        if (!hasAnswers) Logger.log('  - answers is missing or empty');
      }
      Logger.log('=== EMAIL CHECK END ===');
    }
    
    // Send alert email to admin when assessment is submitted
    if (data.type === 'assessment') {
      try {
        Logger.log('=== SENDING ADMIN ALERT EMAIL ===');
        const adminEmail = 'Gautamkathuria0909@gmail.com';
        
        const alertSubject = 'New Risk Assessment Submitted - ' + (data.name || 'Unknown User');
        const alertBody = `
          <html>
            <body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333;">
              <div style="max-width: 600px; margin: 0 auto; padding: 20px;">
                <h2 style="color: #000;">New Risk Assessment Submission</h2>
                <p>A new risk assessment has been submitted through your website.</p>
                
                <h3 style="color: #000; margin-top: 20px;">Client Information:</h3>
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                  <tr>
                    <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Name:</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${data.name || 'N/A'}</td>
                  </tr>
                  <tr>
                    <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Email:</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${data.email || 'N/A'}</td>
                  </tr>
                  <tr>
                    <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Phone:</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${data.phone || 'N/A'}</td>
                  </tr>
                  <tr>
                    <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Age:</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${data.age || 'N/A'}</td>
                  </tr>
                  <tr>
                    <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Service:</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${data.service || 'N/A'}</td>
                  </tr>
                </table>
                
                <h3 style="color: #000; margin-top: 20px;">Assessment Results:</h3>
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                  <tr>
                    <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Financial Info Score:</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${data.financialInfoScore || 'N/A'}</td>
                  </tr>
                  <tr>
                    <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Investment Experience Score:</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${data.investmentExperienceScore || 'N/A'}</td>
                  </tr>
                  <tr>
                    <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Risk Capacity:</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${data.riskCapacity || 'N/A'}</td>
                  </tr>
                  <tr>
                    <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Risk Behaviour:</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${data.riskBehaviour || 'N/A'}</td>
                  </tr>
                  <tr>
                    <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Final Risk Score:</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${data.riskScore || 'N/A'}</td>
                  </tr>
                  <tr>
                    <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Risk Bucket:</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${data.riskBucket || 'N/A'}</td>
                  </tr>
                  <tr>
                    <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Equity Allocation:</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${data.equityAllocation || 'N/A'}</td>
                  </tr>
                  <tr>
                    <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Debt Allocation:</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${data.debtAllocation || 'N/A'}</td>
                  </tr>
                  <tr>
                    <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Alternatives Allocation:</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${data.alternativesAllocation || 'N/A'}</td>
                  </tr>
                </table>
                
                <p style="margin-top: 20px; font-size: 0.9em; color: #666;">
                  <strong>Submitted at:</strong> ${data.timestamp || new Date().toISOString()}
                </p>
                
                <p style="margin-top: 20px;">
                  <a href="https://console.firebase.google.com/project/${FIREBASE_PROJECT_ID}/firestore" style="background-color: #000; color: #fff; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block;">
                    View in Firebase Console
                  </a>
                </p>
              </div>
            </body>
          </html>
        `;
        
        MailApp.sendEmail({
          to: adminEmail,
          subject: alertSubject,
          htmlBody: alertBody,
          name: 'Financial Planning Advisory - Risk Assessment System'
        });
        
        Logger.log('✓ Admin alert email sent successfully to: ' + adminEmail);
      } catch (alertError) {
        Logger.log('✗✗✗ ERROR sending admin alert email: ' + alertError.toString());
        Logger.log('Alert Error message: ' + alertError.message);
        // Don't fail the whole request if alert email fails
      }
    }
    
    Logger.log('doPost completed successfully');
    return ContentService.createTextOutput(JSON.stringify({success: true}))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    Logger.log('✗✗✗ ERROR in doPost: ' + error.toString());
    Logger.log('Error message: ' + error.message);
    Logger.log('Error stack: ' + (error.stack || 'No stack trace'));
    return ContentService.createTextOutput(JSON.stringify({
      error: error.toString(),
      message: error.message
    }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

